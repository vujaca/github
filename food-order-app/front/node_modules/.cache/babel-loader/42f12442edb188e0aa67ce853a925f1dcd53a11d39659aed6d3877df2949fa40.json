{"ast":null,"code":"import jwt_decode from 'jwt-decode';\nimport { json, redirect } from 'react-router-dom';\nimport Axios from '../apis/Axios';\nexport async function action(_ref) {\n  let {\n    request\n  } = _ref;\n  const searchParams = new URL(request.url).searchParams;\n  const mode = searchParams.get('mode') || 'login';\n  if (mode !== 'login' && mode !== 'signup') {\n    throw json({\n      message: 'Unsupported mode.'\n    }, {\n      status: 422\n    });\n  }\n  const data = await request.formData();\n  const cred = {\n    username: data.get('username'),\n    password: data.get('password')\n  };\n  const response = await Axios.post('/korisnici/auth', cred);\n  if (response.status === 422 || response.status === 401) {\n    return response;\n  }\n  if (response.status === 403) {\n    throw json({\n      message: 'Wrong username or password'\n    }, {\n      status: 403\n    });\n  }\n  if (!response.status === 200) {\n    throw json({\n      message: 'Could not authenticate user.'\n    });\n  }\n  const jwt_decoded = jwt_decode(response.data);\n  localStorage.setItem('jwt', response.data);\n  localStorage.setItem('role', jwt_decoded.role.authority);\n  const expiration = new Date();\n  expiration.setHours(expiration.getHours() + 1);\n  localStorage.setItem('expiration', expiration.toISOString());\n  return redirect('/');\n}\nexport const logout = () => {\n  localStorage.removeItem('jwt');\n  localStorage.removeItem('role');\n  localStorage.removeItem('expiration');\n  window.location.replace('/');\n};\nexport const getTokenDuration = () => {\n  const storedExpirationDate = localStorage.getItem('expiration');\n  const expirationDate = new Date(storedExpirationDate);\n  const now = new Date();\n  const duration = expirationDate.getTime = now.getTime();\n  return duration;\n};\nexport const getAuthToken = () => {\n  const token = localStorage.getItem('jwt');\n  if (!token) {\n    return null;\n  }\n  const tokenDuration = getTokenDuration();\n  if (tokenDuration < 0) {\n    return 'EXPIRED';\n  }\n  return token;\n};\nexport const tokenLoader = () => {\n  return getAuthToken();\n};","map":{"version":3,"names":["jwt_decode","json","redirect","Axios","action","_ref","request","searchParams","URL","url","mode","get","message","status","data","formData","cred","username","password","response","post","jwt_decoded","localStorage","setItem","role","authority","expiration","Date","setHours","getHours","toISOString","logout","removeItem","window","location","replace","getTokenDuration","storedExpirationDate","getItem","expirationDate","now","duration","getTime","getAuthToken","token","tokenDuration","tokenLoader"],"sources":["C:/Users/Rajko Andjic/Desktop/Repository/github/food-order-app/front/src/services/auth.js"],"sourcesContent":["import jwt_decode from 'jwt-decode';\r\nimport { json, redirect } from 'react-router-dom';\r\nimport Axios from '../apis/Axios';\r\n\r\n\r\nexport async function action({request}) {\r\n    const searchParams = new URL(request.url).searchParams\r\n    const mode = searchParams.get('mode') || 'login'\r\n\r\n    if(mode !== 'login' && mode !== 'signup') {\r\n        throw json({message: 'Unsupported mode.'}, {status: 422})\r\n    }\r\n\r\n    const data = await request.formData()\r\n    \r\n    const cred = {\r\n        username: data.get('username'),\r\n        password: data.get('password')\r\n    }\r\n\r\n        const response = await Axios.post('/korisnici/auth', cred)\r\n        if(response.status === 422 || response.status === 401) {\r\n            return response\r\n        }\r\n        if(response.status === 403) {\r\n            throw json({message: 'Wrong username or password'}, {status: 403})\r\n        }\r\n        if(!response.status === 200) {\r\n            throw json({message: 'Could not authenticate user.'})\r\n        }\r\n        const jwt_decoded = jwt_decode(response.data)\r\n        localStorage.setItem('jwt', response.data)\r\n        localStorage.setItem('role', jwt_decoded.role.authority)\r\n        const expiration = new Date()\r\n        expiration.setHours(expiration.getHours()+1)\r\n        localStorage.setItem('expiration', expiration.toISOString())\r\n        return redirect('/')\r\n    \r\n}\r\n\r\nexport const logout = () => {\r\n    localStorage.removeItem('jwt')\r\n    localStorage.removeItem('role')\r\n    localStorage.removeItem('expiration')\r\n    window.location.replace('/')\r\n}\r\n\r\nexport const getTokenDuration = () => {\r\n    const storedExpirationDate = localStorage.getItem('expiration')\r\n    const expirationDate = new Date(storedExpirationDate)\r\n    const now = new Date()\r\n    const duration = expirationDate.getTime = now.getTime()\r\n    return duration\r\n}\r\n\r\nexport const getAuthToken = () => {\r\n    const token = localStorage.getItem('jwt')\r\n\r\n    if(!token) {\r\n        return null\r\n    }\r\n\r\n    const tokenDuration = getTokenDuration()\r\n\r\n    if(tokenDuration <0) {\r\n        return 'EXPIRED'\r\n    }\r\n\r\n    return token;\r\n}\r\n\r\nexport const tokenLoader = () => {\r\n    return getAuthToken()\r\n}"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}